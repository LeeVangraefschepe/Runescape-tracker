<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Skill Progress Over Time</title>
    <link rel="icon" href="https://runescape.wiki/images/thumb/Statistics.png/21px-Statistics.png?72ca5" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f9f9f9;
            padding: 20px;
        }
        h1 {
            font-size: 24px;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            margin-bottom: 40px;
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
</head>
<body>

<h1>Skill XP Over Time - lee_vgs</h1>
<div id="charts"></div>

<script>
    async function fetchData() {
        const res = await fetch('http://localhost:999/api/skillvalues?username=lee_vgs');
        return await res.json();
    }

    function getRandomColor(seed) {
        const hash = Array.from(seed).reduce((acc, c) => acc + c.charCodeAt(0), 0);
        const hue = hash % 360;
        return `hsl(${hue}, 70%, 50%)`;
    }

    function drawChart(skill, dataPoints) {
        const container = document.createElement('div');
        container.className = 'chart-container';
        const canvas = document.createElement('canvas');
        container.appendChild(canvas);
        document.getElementById('charts').appendChild(container);

        const image = new Image();
        image.src = `https://runescape.wiki/images/${skill}_detail.png?0f0af`;
        image.crossOrigin = 'anonymous';

        image.onload = () => renderChart(image);
        image.onerror = () => renderChart(null);

        function renderChart(icon) {
            const backgroundIconPlugin = {
                id: 'backgroundIcon',
                afterDraw(chart) {
                    if (!icon) return;
                    const ctx = chart.ctx;
                    const { chartArea } = chart;
                    const size = 100;
                    const x = (chartArea.left + chartArea.right) / 2 - size / 2;
                    const y = (chartArea.top + chartArea.bottom) / 2 - size / 2;
                    ctx.save();
                    ctx.globalAlpha = 0.07;
                    ctx.drawImage(icon, x, y, size, size);
                    ctx.restore();
                }
            };

            new Chart(canvas, {
                type: 'line',
                data: {
                    datasets: [{
                        label: `${skill} Total XP`,
                        data: dataPoints,
                        borderColor: getRandomColor(skill),
                        backgroundColor: 'rgba(0, 0, 0, 0.05)',
                        fill: true,
                        tension: 0.1,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                tooltipFormat: 'MMM d, yyyy HH:mm',
                                unit: 'day'
                            },
                            ticks: { color: '#444' },
                            grid: { color: '#eee' }
                        },
                        y: {
                            title: { display: true, text: 'Total XP' },
                            beginAtZero: false,
                            ticks: { color: '#444' },
                            grid: { color: '#eee' }
                        }
                    }
                },
                plugins: [backgroundIconPlugin]
            });
        }
    }

    function processData(rawData) {
        // Ensure entries are sorted
        rawData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        const skillMap = {};

        for (const entry of rawData) {
            const timestamp = entry.timestamp;
            for (const [skill, xp] of Object.entries(entry.skillXp)) {
                if (!skillMap[skill]) skillMap[skill] = [];
                skillMap[skill].push({
                    x: timestamp,
                    y: xp
                });
            }
        }

        return skillMap;
    }

    fetchData().then(data => {
        const skillData = processData(data);
        Object.entries(skillData).forEach(([skill, points]) => {
            drawChart(skill, points);
        });
    }).catch(err => {
        document.body.innerHTML = `<p style="color:red">Failed to load data.</p>`;
        console.error(err);
    });
</script>

</body>
</html>
